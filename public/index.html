<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>COTAÇÃO</title>
  <style>
    :root{
      --line:#000;
      --soft:#dcdcdc;
      --head:#f2f2f2;
      --ink:#000;
      --ok:#2e7d32;
      --warn:#ef6c00;
      --bad:#c62828;
      --muted:#6b7280;
    }
    *{box-sizing:border-box}
    body{
      font-family: Arial, Helvetica, sans-serif;
      margin:12px;
      color:var(--ink);
      font-size:12px;
    }

    /* ===== Header ===== */
    .sheet{
      border:1.6px solid var(--line);
    }
    .row{display:flex; gap:0}
    .col{flex:1}
    .box{
      border-top:1.6px solid var(--line);
      border-left:1.6px solid var(--line);
      padding:6px 8px;
      min-height:34px;
    }
    .box:last-child{border-right:1.6px solid var(--line)}
    .box.header{display:flex; align-items:center; gap:8px; border-top:none}
    .logo{
      width:120px; height:auto; display:block; object-fit:contain;
      margin:6px 8px;
    }
    .title{
      font-size:22px; font-weight:700; color:#0d602b; letter-spacing:.3px;
    }
    .hdr-right{
      margin-left:auto; width:45%; border-left:1.6px solid var(--line); display:flex; flex-direction:column;
    }
    .hdr-grid{display:grid; grid-template-columns:36% 64%;}
    .cell{border-bottom:1.6px solid var(--line); padding:6px 8px;}
    .cell:nth-child(odd){border-right:1.6px solid var(--line); font-weight:700}
    .cell:last-child{border-bottom:none}

    /* Section headings */
    .sec-head{
      font-weight:700; padding:6px 8px; background:var(--head);
      border-top:1.6px solid var(--line); border-left:1.6px solid var(--line); border-right:1.6px solid var(--line);
    }

    /* Info grids */
    .grid-2{display:grid; grid-template-columns:1fr 1fr;}
    .grid-3{display:grid; grid-template-columns:1fr 1fr 1fr;}
    .kv{display:grid; grid-template-columns:30% 70%}
    .kv .k{font-weight:700; border-right:1.6px solid var(--line)}
    .kv > div{padding:6px 8px; border-top:1.6px solid var(--line); border-left:1.6px solid var(--line)}
    .kv:last-child > div{border-right:1.6px solid var(--line)}

    /* Table */
    table{width:100%; border-collapse:collapse}
    th, td{
      border:1.6px solid var(--line);
      padding:6px 8px; text-align:left; vertical-align:top;
    }
    thead th{background:var(--head)}
    tfoot td{font-weight:700}

    /* Totals block (right aligned grid) */
    .totals{
      display:grid; grid-template-columns:70% 15% 15%;
      border-left:1.6px solid var(--line); border-right:1.6px solid var(--line);
    }
    .totals div{
      border-bottom:1.6px solid var(--line); padding:6px 8px;
    }
    .totals .label{font-weight:700; border-right:1.6px solid var(--line)}
    .totals .val{text-align:right}

    /* Observações & approvals */
    .obs{
      border:1.6px solid var(--line); height:140px; padding:6px 8px
    }
    .approvals{display:grid; grid-template-columns:1fr 1fr 1fr;}
    .ap-col{border:1.6px solid var(--line); height:120px; padding:6px 8px; position:relative}
    .ap-caption{position:absolute; left:6px; bottom:6px; font-size:11px; color:var(--muted)}
    .pix-hint{position:absolute; right:8px; bottom:6px; font-size:11px; color:var(--muted)}

    /* Footer general data */
    .foot-head{background:var(--head); border:1.6px solid var(--line); border-bottom:none; padding:6px 8px; font-weight:700}
    .foot-grid{display:grid; grid-template-columns:1fr 1fr 1fr 1fr; border-left:1.6px solid var(--line); border-right:1.6px solid var(--line)}
    .foot-grid > div{border-bottom:1.6px solid var(--line); border-right:1.6px solid var(--line); padding:6px 8px}
    .foot-grid > div:nth-child(4n){border-right:none}

    /* Status badge (kept) */
    .status-badge{
      display:inline-block; padding:4px 10px; border-radius:4px; font-weight:700; color:#fff; font-size:11px; margin-left:8px;
    }
    .status-accepted{background:var(--ok)}
    .status-negotiated{background:var(--warn)}
    .status-denied{background:var(--bad)}
    .status-pending{background:#6b7280}
    .status-expired{background:#111}
    .status-discarded{background:#6b7280}

    /* Actions + input area */
    .response-wrap{border:1.6px solid var(--line); border-top:none; padding:10px 8px}
    .inputs{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    label{font-weight:700; display:block; margin-bottom:4px}
    input[type="text"], textarea{
      width:100%; border:1px solid #bdbdbd; padding:6px 8px; font-size:12px; border-radius:2px
    }
    textarea{height:72px; resize:vertical}
    .actions{display:flex; justify-content:center; gap:8px; margin:12px 0 6px}
    .btn{border:none; color:#fff; padding:10px 16px; font-size:12px; cursor:pointer}
    .accept-btn{background:var(--ok)}
    .negotiate-btn{background:var(--warn)}
    .deny-btn{background:var(--bad)}

    /* Footer message (status result) */
    .status-foot{
      text-align:center; font-weight:700; padding:10px; margin-top:6px;
      border:1.6px solid var(--line);
    }
    .status-foot.accepted{background:#d4edda; color:#155724}
    .status-foot.denied,.status-foot.discarded{background:#f8d7da; color:#721c24}
    .status-foot.expired{background:#f0f0f0; color:#333}

    /* Print */
    @media print{
      .actions{display:none!important}
      .btn{display:none!important}
      input, textarea{border:none}
    }

    /* Small screens */
    @media (max-width: 768px){
      .hdr-right{width:100%; border-left:none; border-top:1.6px solid var(--line)}
      .inputs{grid-template-columns:1fr}
      body{font-size:11px}
    }
  </style>
</head>
<body>
  <!-- ===== SHEET ===== -->
  <div class="sheet">
    <!-- Header row -->
    <div class="row">
      <div class="col">
        <div class="box header" style="border-right:none">
          <img class="logo" src="logo.png" alt="NIMO ENERGIA DISTRIBUIDORA"/>
          <div>
            <div class="title">COTAÇÃO <span id="status-badge"></span></div>
          </div>
        </div>
      </div>
      <div class="hdr-right">
        <div class="hdr-grid">
          <div class="cell">Nº do pedido</div><div class="cell" id="hdr-num">—</div>
          <div class="cell">Data pedido</div><div class="cell" id="hdr-date">—</div>
          <div class="cell">Empresa</div><div class="cell" id="hdr-company">—</div>
          <div class="cell">Depósito</div><div class="cell" id="hdr-deposito">—</div>
        </div>
      </div>
    </div>

    <!-- Cliente / Endereços -->
    <div class="sec-head">Cliente Comprador</div>
    <div class="kv grid-2">
      <div class="k">Cliente</div><div id="cli-name">—</div>
      <div class="k">CNPJ / Contato</div><div id="cli-doc">—</div>
    </div>

    <div class="sec-head">Endereços</div>
    <div class="grid-3">
      <div class="kv">
        <div class="k">Faturamento</div><div id="addr-fat">—</div>
      </div>
      <div class="kv">
        <div class="k">Cobrança</div><div id="addr-cob">—</div>
      </div>
      <div class="kv">
        <div class="k">Entrega</div><div id="addr-ent">—</div>
      </div>
    </div>

    <!-- Itens -->
    <div class="sec-head">Itens Pedido</div>
    <table id="items">
      <thead>
      <tr>
        <th style="width:12%">Código</th>
        <th>Descrição Completa</th>
        <th style="width:8%">Und</th>
        <th style="width:10%">Qtde</th>
        <th style="width:12%">Preço Unit.</th>
        <th style="width:12%">Preço Total</th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Totais -->
    <div class="totals">
      <div class="label">Total Produtos</div><div></div><div class="val" id="tot-prod">—</div>
      <div class="label">Seguro</div><div></div><div class="val" id="tot-seguro">0,00</div>
      <div class="label">Frete</div><div></div><div class="val" id="tot-frete">0,00</div>
      <div class="label">Total Pedido</div><div></div><div class="val" id="tot-geral">—</div>
    </div>

    <!-- Observações -->
    <div class="sec-head">Observações</div>
    <div class="obs" id="terms"></div>

    <!-- Approvals / QR -->
    <div class="approvals">
      <div class="ap-col"><span class="ap-caption">Visto Vendas — Requer Aprovação</span></div>
      <div class="ap-col"><span class="ap-caption">Visto Financeiro — Requer Aprovação</span></div>
      <div class="ap-col"><span class="ap-caption">Pgto eletrônico pelo QR code</span><span class="pix-hint">chave pix</span></div>
    </div>

    <!-- Dados Gerais -->
    <div class="foot-head">Dados Gerais Pedido</div>
    <div class="foot-grid" id="general-grid">
      <div><b>Transportadora:</b> <span id="fg-transport">—</span></div>
      <div><b>Placas:</b> <span id="fg-placas">—</span></div>
      <div><b>Motorista:</b> <span id="fg-motorista">—</span></div>
      <div><b>Retira / Entrega:</b> <span id="fg-retira">—</span></div>
      <div><b>Vendedor:</b> <span id="fg-vendedor">—</span></div>
      <div><b>Assistente:</b> <span id="fg-assistente">—</span></div>
      <div><b>Condições Pagto:</b> <span id="fg-cond">—</span></div>
      <div><b>Forma Pagto:</b> <span id="fg-forma">—</span></div>
    </div>

    <!-- Response + Buttons -->
    <div class="response-wrap" id="response-section">
      <div class="inputs">
        <div>
          <label for="ackBy">Nome</label>
          <input type="text" id="ackBy" placeholder="Digite seu nome"/>
        </div>
        <div>
          <label for="comment">Comentário</label>
          <textarea id="comment" placeholder="Digite seu comentário"></textarea>
        </div>
      </div>
      <div class="actions" id="actions">
        <!-- Buttons injected by JS depending on status -->
      </div>
    </div>

    <div id="footer-message" class="status-foot" style="display:none;"></div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const qid = urlParams.get("qid");
    const token = urlParams.get("token");

    function brl(v){
      return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL",minimumFractionDigits:2}).format(+v || 0);
    }

    async function loadQuote(){
      const resp = await fetch(`/api/quote?qid=${qid}&token=${token}`);
      const payload = await resp.json();

      if(!payload.ok){
        document.body.innerHTML =
          `<h2 style="color:red; text-align:center;">${payload.error}</h2>
           <p style="text-align:center;">Para qualquer dúvida, entre em contato com o representante de vendas.</p>`;
        return;
      }

      const q = payload.data;

      // Header values (fallbacks keep template look even if missing fields)
      document.getElementById("hdr-num").textContent = q.order_no || q.quote_no || "—";
      document.getElementById("hdr-date").textContent = q.date || q.valid_till || "—";
      document.getElementById("hdr-company").textContent = q.empresa || (q.company || "—");
      document.getElementById("hdr-deposito").textContent = q.deposito || q.deposit || "—";

      // Status badge + footer
      let statusClass = "status-pending", statusText = "Pendente";
      let footClass = "", footMsg = "", foot = document.getElementById("footer-message");

      if(q.status === "Accepted"){ statusClass="status-accepted"; statusText="Aceita"; footClass="accepted"; footMsg=`Cotação foi Aceita por ${q.ack_by||""} em ${new Date().toLocaleString("pt-BR")}`; }
      else if(q.status === "Denied"){ statusClass="status-denied"; statusText="Recusada"; footClass="denied"; footMsg=`Cotação foi Recusada por ${q.ack_by||""} em ${new Date().toLocaleString("pt-BR")}`; }
      else if(q.status === "Negotiated"){ statusClass="status-negotiated"; statusText="Em Negociação"; }
      else if(q.status === "Expired"){ statusClass="status-expired"; statusText="Expirada"; footClass="expired"; footMsg="Esta cotação expirou."; }
      else if(q.status === "Discarded"){ statusClass="status-discarded"; statusText="Descartada"; footClass="discarded"; footMsg="Orçamento já recusado. Caso tenha alguma dúvida, entre em contato com nosso representante de vendas."; }

      document.getElementById("status-badge").outerHTML = `<span class="status-badge ${statusClass}">${statusText}</span>`;
      if(footMsg){
        foot.className = `status-foot ${footClass}`;
        foot.style.display = "block";
        foot.textContent = footMsg;
      }

      // Cliente + Endereços (use your fields or keep placeholders)
      document.getElementById("cli-name").textContent = q.company || "—";
      document.getElementById("cli-doc").textContent = q.cnpj || q.client_doc || "—";
      document.getElementById("addr-fat").textContent = q.address_billing || q.address || "—";
      document.getElementById("addr-cob").textContent = q.address_cobranca || q.address_billing || "—";
      document.getElementById("addr-ent").textContent = q.address_entrega || q.address_shipping || "—";

      // Items table (mapped from your products list)
      const tbody = document.querySelector("#items tbody");
      const items = Array.isArray(q.products) ? q.products : [];
      let totalProdutos = 0;

      tbody.innerHTML = items.map((p, i) => {
        const und = p.unit || "L";
        const qtd = +p.quantity || 0;
        const unitPrice = +p.unit_price || +p.price || 0;
        const line = +(p.total || (qtd * unitPrice));
        totalProdutos += line;
        return `<tr>
          <td>${p.code || String(i+1).padStart(3,"0")}</td>
          <td>${p.product_name || p.name || ""}</td>
          <td>${und}</td>
          <td>${qtd.toLocaleString("pt-BR")}</td>
          <td>${brl(unitPrice)}</td>
          <td>${brl(line)}</td>
        </tr>`;
      }).join("");

      // Totals
      const seguro = +q.seguro || 0;
      const frete  = +q.frete  || 0;
      const grand  = q.grand_total != null ? +q.grand_total : (totalProdutos + seguro + frete);

      document.getElementById("tot-prod").textContent = brl(totalProdutos);
      document.getElementById("tot-seguro").textContent = brl(seguro);
      document.getElementById("tot-frete").textContent = brl(frete);
      document.getElementById("tot-geral").textContent = brl(grand);

      // Terms (observações)
      document.getElementById("terms").textContent = q.terms || q.observacoes || "";

      // Dados gerais (fill if you have them; stays pretty if you don't)
      document.getElementById("fg-transport").textContent = q.transportadora || "—";
      document.getElementById("fg-placas").textContent = q.placas || "—";
      document.getElementById("fg-motorista").textContent = q.motorista || "—";
      document.getElementById("fg-retira").textContent = q.retirada || q.entrega || "—";
      document.getElementById("fg-vendedor").textContent = q.vendedor || "—";
      document.getElementById("fg-assistente").textContent = q.assistente || "—";
      document.getElementById("fg-cond").textContent = q.condicoes || "—";
      document.getElementById("fg-forma").textContent = q.forma_pagto || "—";

      // Inputs (preserve your rules)
      const ackField = document.getElementById("ackBy");
      const commentField = document.getElementById("comment");
      const responseSection = document.getElementById("response-section");

      ackField.value = q.ack_by || "";
      commentField.value = q.client_response || "";

      if (q.status === "Accepted" || q.status === "Denied"){
        ackField.readOnly = true; commentField.readOnly = true;
        ackField.style.backgroundColor = "#f2f2f2"; commentField.style.backgroundColor = "#f2f2f2";
        responseSection.style.display = "block";
      } else if (q.status === "Expired" || q.status === "Discarded"){
        responseSection.style.display = "none";
      } else {
        ackField.readOnly = false; commentField.readOnly = false;
        ackField.style.backgroundColor = "#fff"; commentField.style.backgroundColor = "#fff";
        responseSection.style.display = "block";
      }

      // Buttons (same behavior, restyled)
      const actions = document.getElementById("actions");
      if (q.status === "Pending" || q.status === "Negotiated"){
        actions.innerHTML = `
          <button class="btn accept-btn" onclick="sendResponse('Accepted')">Aceitar</button>
          <button class="btn negotiate-btn" onclick="sendResponse('Negotiated')">Negociar</button>
          <button class="btn deny-btn" onclick="sendResponse('Denied')">Recusar</button>
        `;
      } else {
        actions.innerHTML = "";
      }
    }

    async function sendResponse(action){
      const name = document.getElementById("ackBy").value.trim();
      const comment = document.getElementById("comment").value.trim();

      if ((action === "Denied" || action === "Negotiated") && (!name || !comment)){
        alert("Por favor, preencha os Comentários em caso de negação ou negociação.");
        return;
      }
      if (action === "Accepted" && !name){
        alert("Por favor, preencha o Nome antes de aceitar.");
        return;
      }

      const resp = await fetch("/api/respond",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ qid, action, comment, name })
      });
      const data = await resp.json();
      if(data.ok){
        alert(`Cotação atualizada como ${action}!`);
        window.location.reload();
      }else{
        alert("Falha: " + JSON.stringify(data));
      }
    }

    loadQuote();
  </script>
</body>
</html>
