<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EasyQuote</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 20px;
      background: #f4f6f9;
      color: #333;
    }

    .quote-box {
      background: #fff;
      border-radius: 12px;
      max-width: 900px;
      margin: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 30px;
      position: relative;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
      position: relative;
    }

    .logo {
      height: 80px;
      display: block;
      margin: auto;
    }

    h1 {
      font-family: 'Poppins', sans-serif;
      color: #2c3e50;
      margin: 10px 0;
      font-size: 26px;
    }

    .valid-till {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #2980b9;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
    }

    .status {
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      display: inline-block;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-top: 6px;
    }

    .status.Accepted { background: #e9f9ee; color: #27ae60; }
    .status.Denied { background: #fdecea; color: #c0392b; }
    .status.Negotiated { background: #fff7e6; color: #e67e22; }
    .status.Pending { background: #eaf3ff; color: #2980b9; }
    .status.Discarded { background: #f0f0f0; color: #7f8c8d; }

    #details p {
      margin: 6px 0;
    }

    h3 {
      font-family: 'Poppins', sans-serif;
      margin-top: 25px;
      color: #2c3e50;
      border-left: 4px solid #2980b9;
      padding-left: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      border-radius: 8px;
      overflow: hidden;
    }

    th, td {
      border: 1px solid #eee;
      padding: 12px;
      text-align: left;
      font-size: 15px;
    }

    th {
      background: #f9fafc;
      font-weight: 600;
    }

    .highlight {
      background: #27ae60;
      color: white;
      padding: 8px 14px;
      border-radius: 8px;
      font-weight: bold;
      display: inline-block;
      margin-top: 15px;
      font-size: 16px;
    }

    .actions {
      margin-top: 30px;
      text-align: center;
    }

    button {
      margin: 8px;
      padding: 12px 24px;
      font-size: 15px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      transition: 0.3s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    button.accept { background: #27ae60; color: white; }
    button.accept:hover { background: #219150; }

    button.negotiate { background: #e67e22; color: white; }
    button.negotiate:hover { background: #cf711f; }

    button.deny { background: #c0392b; color: white; }
    button.deny:hover { background: #a93226; }

    .error { color: #c0392b; font-weight: bold; }
    .success { color: #27ae60; font-weight: bold; }

    /* Responsive Layout */
    @media (max-width: 768px) {
      .quote-box { padding: 20px; }
      h1 { font-size: 22px; }
      th, td { font-size: 14px; }
      td { word-break: break-word; }
      table, thead, tbody, th, td, tr { display: block; width: 100%; }
      th { display: none; }
      tr { margin-bottom: 12px; border-bottom: 1px solid #eee; }
      td { border: none; padding: 8px 0; }
      td::before {
        font-weight: bold;
        display: inline-block;
        width: 130px;
      }
      td:nth-of-type(1)::before { content: "Product: "; }
      td:nth-of-type(2)::before { content: "Quantity: "; }
      td:nth-of-type(3)::before { content: "Price: "; }
      td:nth-of-type(4)::before { content: "Total: "; }
    }
  </style>
</head>
<body>
  <div class="quote-box">
    <div class="header">
      <img src="/logo.png" alt="Company Logo" class="logo">
      <div class="valid-till" id="validTill"></div>
      <h1 id="title">Loading Quote...</h1>
      <p id="subtitle"></p>
    </div>
    <div id="details"></div>
    <div id="deal"></div>
    <div id="items"></div>
    <div id="grandTotal"></div>
    <div id="terms"></div>
    <div class="actions" id="actions"></div>
  </div>

  <script>
    const qs = new URLSearchParams(window.location.search);
    const qid = qs.get("qid");
    const token = qs.get("token");

    const el = (id) => document.getElementById(id);

    async function loadQuote() {
      if (!qid || !token) {
        el("title").innerText = "Invalid Link";
        el("subtitle").innerHTML = "<span class='error'>Missing qid or token in URL.</span>";
        return;
      }

      const r = await fetch(`/api/quote?qid=${encodeURIComponent(qid)}&token=${encodeURIComponent(token)}`);
      const data = await r.json();

      if (!data.ok) {
        el("title").innerText = "Quote Error";
        el("subtitle").innerHTML = `<span class='error'>${data.error}</span>`;
        return;
      }

      const q = data.data;
      const status = (q.status || "Pending").trim();

      el("title").innerText = "Quotation #" + q.quote_number;

      let statusHtml = `<span class="status ${status}">${status}`;
      if (q.accepted_on) statusHtml += ` on ${q.accepted_on}`;
      statusHtml += "</span>";
      el("subtitle").innerHTML = `${q.subject} | ${statusHtml}`;

      // Valid Till top right
      el("validTill").innerText = q.valid_till ? "Valid Till: " + q.valid_till : "";

      // Remove Owner, keep Contact only
      el("details").innerHTML = `
        <p><b>Contact:</b> ${q.contact_name || ""}</p>
      `;

      // Deal before Items
      el("deal").innerHTML = q.deal_name ? `<h3>Deal</h3><p>${q.deal_name}</p>` : "";

      let itemsHtml = "<h3>Items</h3><table><tr><th>Product</th><th>Qty</th><th>Price</th><th>Total</th></tr>";
      (q.products || []).forEach(p => {
        itemsHtml += `<tr><td>${p.product_name || ""}</td><td>${p.quantity ?? ""}</td><td>${p.list_price ?? ""}</td><td>${p.total ?? ""}</td></tr>`;
      });
      itemsHtml += "</table>";
      el("items").innerHTML = itemsHtml;

      // Grand Total after table
      el("grandTotal").innerHTML = q.grand_total ? `<p><span class="highlight">Grand Total: ${q.grand_total}</span></p>` : "";

      el("terms").innerHTML = "<h3>Terms & Conditions</h3><p>" + (q.terms || "None") + "</p>";

      const actions = el("actions");
      actions.innerHTML = "";

      if (["Accepted", "Denied", "Discarded"].includes(status)) {
        actions.innerHTML = `<p class='success'>This quote has been ${status}${q.accepted_on ? " on " + q.accepted_on : ""}.</p>`;
        return;
      }

      const buttons = [
        { label: "Accept", value: "Accepted", cls: "accept" },
        { label: "Negotiate", value: "Negotiated", cls: "negotiate" },
        { label: "Denied", value: "Denied", cls: "deny" },
      ];

      buttons.forEach(({label, value, cls}) => {
        const btn = document.createElement("button");
        btn.innerText = label;
        btn.classList.add(cls);
        btn.onclick = () => doRespond(value);
        actions.appendChild(btn);
      });
    }

    async function doRespond(action) {
      const comment = prompt("Enter comment (optional):") || "";
      const name = prompt("Please enter your name:") || "";

      const r = await fetch("/api/respond", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ qid, token, action, comment, name })
      });

      const data = await r.json();
      if (data.ok) {
        alert(`Quote updated as ${action}!`);
        location.reload();
      } else {
        alert("Failed: " + JSON.stringify(data));
      }
    }

    loadQuote();
  </script>
</body>
</html>
